<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>
<h3 id="overview">Overview</h3>
<p>BETYdb runs on a Red Hat Enterprise Linux version 5.8 Server. To simulate this environment, we have set up a CentOS 5.8 server at pecandev.igb.illinois.edu for testing</p>
<h3 id="create-an-netinstall-of-the-centos-iso">Create an netinstall of the CentOS ISO</h3>
<h3 id="boot-from-cd-and-install">Boot from CD and Install</h3>
<ul>
<li>Following instructions here: http://www.if-not-true-then-false.com/2010/centos-netinstall-network-installation/</li>
<li>Download this iso: http://vault.centos.org/5.8/isos/x86_64/CentOS-5.8-x86_64-netinstall.iso</li>
<li>it is the &quot;netinstall&quot; version, small enough to fit on a CD, but requires internet to install</li>
<li>burn to CD</li>
<li>boot from CD</li>
<li>ftp server: <code>vault.centos.org</code></li>
<li>directory: <code>5.8/os/x86_64</code></li>
</ul>
<h3 id="configuration">Configuration</h3>
<ol style="list-style-type: decimal">
<li>Add new user <code>adduser johndoe</code></li>
<li>add user to root <code>sudo su emacs /etc/sudoers</code></li>
<li><p>add the line</p>
<pre><code>johndoe  ALL=(ALL)  ALL</code></pre></li>
<li><p>Keep time updated (source: <a href="http://serverfault.com/q/368602">ServerFault</a>)</p></li>
</ol>
<p><code>{bash} yum install ntp /sbin/chkconfig ntpd on         ## check that it is on /usr/sbin/ntpdate pool.ntp.org  ## set system date /etc/init.d/ntpd start</code></p>
<h3 id="add-new-repository">Add new repository</h3>
<p>instructions here: http://www.rackspace.com/knowledge_center/article/installing-rhel-epel-repo-on-centos-5x-or-6x</p>
<pre><code>wget http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm
sudo rpm -Uvh epel-release-5*.rpm</code></pre>
<p>... move to PEcAn wiki page for build environment https://github.com/PecanProject/pecan/wiki/Development-Environment-Setup-and-VM-Creation#install-build-environment</p>
<p>Remember to install R 3.0:</p>
<pre><code>wget http://cran.us.r-project.org/src/base/R-3/R-3.0.1.tar.gz
tar xzf R-3.0.1.tar.gz
cd R-3.0.1
./configure
make
sudo make install</code></pre>
<h3 id="site-data-installation">Site data installation</h3>
<pre><code>cd /usr/local/ebi

rm -rf sites
curl -o sites.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/sites.tgz
tar zxf sites.tgz
sed -i -e &quot;s#/home/kooper/projects/EBI#${PWD}#&quot; sites/*/ED_MET_DRIVER_HEADER
rm sites.tgz

rm -rf inputs
wget http://isda.ncsa.illinois.edu/~kooper/EBI/inputs.tgz
tar zxf inputs.tgz
rm inputs.tgz</code></pre>
<h3 id="database-creation">Database Creation</h3>
<pre><code>#sets up the user for the bety database
mysql -u root -p -e &quot;create database test; create database production;&quot;
mysql -u root -p -e &quot;grant all on bety.* to bety@localhost identified by &#39;bety&#39;;&quot;
wget -O /usr/local/ebi/updatedb.sh http://isda.ncsa.illinois.edu/~kooper/EBI/updatedb.sh
chmod 755 /usr/local/ebi/updatedb.sh</code></pre>
<p>Open up updatedb.sh and remove the two lines</p>
<pre><code>#change to home
cd</code></pre>
<p>If these are left in, the script will attempt to put the site data in ~/sites instead of /usr/local/ebi/sites.</p>
<pre><code>#fetch and updates the bety database
./updatedb.sh</code></pre>
<h3 id="ruby-installation">Ruby installation</h3>
<p>The version of ruby available through yum is too low, so we have to use rvm</p>
<pre><code>user$ \curl -L https://get.rvm.io | sudo bash -s stable
rvm install 1.9
rvm use 1.9

yum upgrade rubygem

yum install mysql-devel.x86_64
yum install ImageMagick-devel.x86_64
yum install rubygem-rails
yum install httpd-devel
wget http://www.sqlite.org/2013/sqlite-autoconf-3071700.tar.gz
tar -xzf sqlite-autoconf-3071700.tar.gz
cd sqlite-autoconf-3071700.tar.gz
./configure
make
make install</code></pre>
<p>Then all the ruby gems bety needs.</p>
<pre><code>cd /usr/local/bety
gem install bundler
bundle install</code></pre>
<p>Configuration for Bety:</p>
<pre><code>cd /usr/local/ebi/bety

# create folders for upload folders
mkdir paperclip/files paperclip/file_names
chmod 777 paperclip/files paperclip/file_names

# create folder for log files
mkdir log
touch log/production.log
chmod 0666 log/production.log
touch log/test.log
chmod 0666 log/test.log

cat &gt; config/database.yml &lt;&lt; EOF
production:
  adapter: mysql2
  encoding: latin1
  reconnect: false
  database: bety
  pool: 5
  username: bety
  password: bety

test:
  adapter: mysql2
  encoding: latin1
  reconnect: false
  database: test
  pool: 5
  username: bety
  password: bety
EOF


# setup login tokens ( actual REST_AUTH_SITE_KEY needs to be replaced with one matching the DB )
cat &gt; config/initializers/site_keys.rb &lt;&lt; EOF
REST_AUTH_SITE_KEY         = &#39;thisisnotasecret&#39;
REST_AUTH_DIGEST_STRETCHES = 10
EOF



# configure apache
ln -s /usr/local/ebi/bety/public /var/www/bety

# http://wiki.apache.org/httpd/DistrosDefaultLayout
cat &gt; /etc/httpd/conf.d/bety.conf &lt;&lt; EOF
RailsEnv production
RailsBaseURI /bety
DocumentRoot /usr/local/ebi/bety/public/
ServerName pecandev.igb.illinois.edu
&lt;Directory /usr/local/beta/public &gt;
        Options FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
&lt;/Directory&gt;
EOF</code></pre>
<p>You may have to change your DocumentRoot in /etc/httpd/conf/httpd.conf from &quot;/var/www/html&quot; to &quot;/var/www&quot; if you get the error message 'Passenger error #2 An error occurred while trying to access '/var/www/html/bety': Cannot resolve possible symlink '/var/www/html/bety': No such file or directory (2)'. Up next make apache2 and passenger play nicely:</p>
<pre><code>rvmsudo passenger-install-apache2-module</code></pre>
<p>If that fails, try</p>
<pre><code>sudo -s
source `rvm gemdir`</code></pre>
<p>Finally run the tests</p>
<pre><code>cd /usr/local/eby/bety/
rake db:test:load &amp;&amp; rake db:fixtures:load RAILS_ENV=test &amp;&amp; rspec spec/</code></pre>
<h3 id="install-models">Install Models</h3>
<p>Install the models biocro, sipnet, and ED as they are installed <a href="https://github.com/PecanProject/pecan/wiki/Installing-PEcAn#install-models">here</a>.</p>
<p>For biocro, there are some dependencies:</p>
<pre><code>echo &quot;install.packages(&#39;devtools&#39;,repos=&#39;http://cran.rstudio.com/&#39;)&quot;| R --vanilla
yum install udunits2-devel
sudo R CMD INSTALL udunits2 --configure-args=&#39;--with-udunits2-include=/usr/include/udunits2&#39;</code></pre>
<h3 id="pecan-installation">Pecan Installation</h3>
<pre><code># download pecan
cd /usr/local/ebi
git clone https://github.com/PecanProject/pecan.git


yum install netcdf-devel.x86_64 netcdf-static.x85_64 openmpi hdf5-devel.x86_64 openmpi-devel
#install PEcAn dependencies
wget http://cran.r-project.org/src/contrib/ncdf4_1.6.1.tar.gz


rpm -Uvh http://www.hdfgroup.org/ftp/HDF5/current/bin/RPMS/hdf5-1.8.11-1.with.szip.encoder.el5.x86_64.rpm

wget http://cran.r-project.org/src/contrib/rjags_3-10.tar.gz

wget http://www.unidata.ucar.edu/downloads/netcdf/ftp/netcdf-4.3.0.tar.gz

tar -xzf netcdf-4.3.0.tar.gz
cd netcdf-4.3.0
export LDFLAGS=&quot;/usr/include/netcdf-3/&quot;
sudo ./configure
sudo make install
cd ..
tar -xzf ncdf4_1.6.1.tar.gz
sudo R CMD INSTALL --configure-args=&quot;--with-nc-config=~/netcdf-4.3.0/nc-config&quot; ncdf4


rpm -Uvh http://www6.atomicorp.com/channels/atomic/centos/5/x86_64/RPMS/sqlite-3.7.0.1-1.el5.art.x86_64.rpm

wget   http://download.osgeo.org/gdal/1.10.0/gdal-1.10.0.tar.gz
tar -xzf gdal-1.10.0.tar.gz
cd gdal-1.10.0
sudo ./configure
sudo make install

sudo yum install atlas blas.x86_64
sudo rpm -Uvh  http://download.opensuse.org/repositories/home:/cornell_vrdc/CentOS_CentOS-5/x86_64/jags3-3.3.0-48.1.x86_64.rpm
sudo rpm -Uvh http://download.opensuse.org/repositories/home:/cornell_vrdc/CentOS_CentOS-5/x86_64/jags3-devel-3.3.0-48.1.x86_64.rpm

yum install proj-devel.x86_64 udunits2-devel.x86_64

wget http://cran.r-project.org/src/contrib/rgdal_0.8-9.tar.gz
tar -xzf rgdal_0.8-9.tar.gz
echo &quot;/usr/local/lib&quot; &gt;&gt; /etc/ld.so.conf.d/gdal.conf
ldconfig -v
R CMD INSTALL rgdal --configure-args=&#39;--with-gdal-config=/usr/local/bin/gdal-config&#39;

# install PEcAn packages in R
cd pecan
R --vanilla &lt; scripts/install.dependencies.R

# compile pecan
./scripts/build.sh</code></pre>
<h3 id="postgresql">PostgreSQL</h3>
<p>Although BETY currently uses MySQL, support for or migration to PostgresSQL is planned.</p>
<h4 id="installing-postgres">Installing Postgres</h4>
<p><a href="http://wiki.postgresql.org/wiki/YUM_Installation">reference</a> add <code>exclude=postgresql*</code> to the <code>[base]</code> and <code>[updates]</code> sections of <code>/etc/yum.repos.d/CentOS-Base.repo</code></p>
<pre><code># download repo
curl -O http://yum.postgresql.org/9.2/redhat/rhel-5-x86_64/pgdg-centos92-9.2-6.noarch.rpm
# install repo
rpm -ivh pgdg-centos92-9.2-6.noarch.rpm 
# list available packages
yum list postgres*
# install postgres 9.2
yum install postgresql92-server

# initialize database
 /sbin/service postgresql-9.2 initdb

# automatically start postgres 
/sbin/chkconfig postgresql-9.2 on</code></pre>
<h4 id="configuring-postgres-reference">configuring postgres <a href="http://wiki.postgresql.org/wiki/First_steps">reference</a></h4>
<pre><code># set root (postgres) password [reference](http://stackoverflow.com/q/12720967)
sudo -u postgres psql
alter user postgres with password &#39;new_password&#39; </code></pre>
<h2 id="installing-virtualbox">Installing Virtualbox</h2>
<p><a href="http://wiki.centos.org/HowTos/Virtualization/VirtualBox#head-81de410879b8e7f18a127f638160e036ab99684e">reference</a></p>
<pre><code>cd /etc/yum.repos.d
wget http://download.virtualbox.org/virtualbox/rpm/rhel/virtualbox.repo
yum install dkms
yum groupinstall &quot;Development Tools&quot;
yum install kernel-devel
yum install VirtualBox-4.2
usermod -a -G vboxusers &lt;username&gt;</code></pre>
</body>
</html>
