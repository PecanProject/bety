name: DB Dump

on:
  push:

jobs:
  sync:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: mdillon/postgis:9.5
        ports: 
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v2

      - name: Setup Database
        run: |
          psql -h localhost -U postgres -c "CREATE ROLE bety WITH LOGIN CREATEDB NOSUPERUSER NOCREATEROLE PASSWORD 'bety'"
          psql -h localhost -U postgres -c "CREATE DATABASE bety WITH OWNER bety"
          psql -h localhost -U postgres -d bety -c "CREATE EXTENSION postgis;"

      - name: Sync with EBI
        run: script/load.bety.sh -a "postgres" -p "-h localhost" -d "bety" -o bety -m 99 -r 0 -w https://ebi-forecast.igb.illinois.edu/pecan/dump/bety.tar.gz

      - name: Sync with BU
        run: script/load.bety.sh -a "postgres" -p "-h localhost" -d "bety" -o bety -m 99 -r 1

      #- name: Sync with BNL
      #  run: script/load.bety.sh -a "postgres" -p "-h localhost" -d "bety" -o bety -m 99 -r 2

      - name: Sync with Wisconsin
        run: script/load.bety.sh -a "postgres" -p "-h localhost" -d "bety" -o bety -m 99 -r 5

      - name: Dump Database
        run: pg_dump -F c bety > initdb/db.dump

      - name: Build Docker with Database dump
        run: |
          cd initdb
          docker build --tag image --file Dockerfile .

